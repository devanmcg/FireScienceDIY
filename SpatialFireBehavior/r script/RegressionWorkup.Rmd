---
title: Preliminary analysis of fire behavior data
date: '`r Sys.Date()`'
---

```{r setup, echo=FALSE, warning=FALSE, message = FALSE, results='hide'}
knitr::opts_chunk$set(message = FALSE, warning=FALSE, 
               echo=FALSE, eval=TRUE, fig.path = "./") 
fp = "C:/Users/Devan.McGranahan/GoogleDrive/FireScienceDIY/SpatialFireBehavior"
load(paste0(fp, "/data/DataCombined.Rdata"))
load(paste0(fp, '/r objects/response_CIs.Rdata'))
```

```{r}
# Packages
  pacman::p_load(tidyverse, mice, broom.mixed)
```

# Data 

## Preparations 

The raw weather, fuels, and fire behavior data used here are available in an [Excel spreadsheet]() and the script used to combine them [available here](). 

Data are limited to $\textsf{Rate of spread < 40 m/s}$ and $\textsf{Maximum temperature > 40}^\circ \textsf{C}$. 

```{r fig.width = 10, fig.height = 8, fig.cap="A scatterplot matrix of all raw data used in this analysis."}
# Filter data
  AnalysisData <- 
    DataCombined %>%
      filter( ros <= 40, 
              tempC >= 40) %>%
        mutate(FuelMoisture = ifelse(FuelMoisture >= 0, 
                                      FuelMoisture, NA), 
               FuelMoisture = FuelMoisture * 100) %>%
  select(-lys)
# Scatterplot matrix  
GGally::ggpairs(AnalysisData, 
                columns = 8:17, 
                upper = 'blank')
```

## Distributions

```{r fig.width = 8, fig.height =4, fig.cap = "Gamma distributions are fit to both response variables."}
# Distributions of response variables
  ros_dist <-
  AnalysisData %>% 
    ggplot(aes(x=ros)) + theme_bw(14) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=0.5,
                   colour="black", 
                   fill="lightgreen") +
    geom_density(alpha=0.2, 
                 fill="#FF6666") 
  tempC_dist <- 
  AnalysisData %>% 
    ggplot(aes(x=tempC)) + theme_bw(14) + 
    geom_histogram(aes(y=..density..),      
                   binwidth=10,
                   colour="black", 
                   fill="lightgreen") +
    geom_density(alpha=0.2, 
                 fill="#FF6666") 
  gridExtra::grid.arrange(ros_dist, tempC_dist, ncol=2)
```

## Correlations of interest 

```{r fig.width = 5, fig.height =4,fig.cap = "Poor linear relationship between rate of spread and maximum temperature."}
# ROS fit against maximum temperature
  AnalysisData %>% 
    ggplot(aes(x=tempC, y = ros, color=location)) + theme_bw(14) +
      geom_point(alpha=0.5)
```

```{r fig.width = 5, fig.height =4, fig.cap="Unexpected and unexplained relationship between soil moisture and fuel moisture. Dropping soil moisture from predictor variables."}
# Fuel moisture fit against soil moisture
  ggplot(AnalysisData, aes(x=SoilMoisture, y=FuelMoisture, color=location)) + 
    geom_smooth(method = 'lm', se=F) + 
    geom_point(alpha=0.5) +
    coord_cartesian(ylim = c(0,200))
```
  
# Regression analysis

## Imputation of missing values

There are several missing values in the data:

```{r }
# MICE operations 
#
# Pattern of missing data
AnalysisData %>%
  select(-location, -block, -pasture,-patch,
         -year, -plot, -array) %>%
    md.pattern(plot = F) %>%
  pander::pander(caption="Table of missing values by variable.") 
```

Therefore I used the multiple imputation method in the **mice** package to fill in missing values. 
The method creates 100 datasets, each with different but reasonable values for the missing data based on patterns in existing data, and performs the regression analysis on each. 
These results are pooled into a single set of results. 

## Model specification 

Mixed-effect regression models fit with `lme4::glmer` and constructed as follows: 

$$y \approx RH + WS + DP + FM + FL + (1|location/block/year/plot),~ 
\text{family=Gamma(link = `log')}$$

where 

$RH$ = Relative humidity,

$WS$ = Average wind speed, 

$DP$ = Dew point, 

$FM$ = Fuel moisture (from clipped samples), 

$FL$ = Fuel load (as estimated by LAI)

Weather variables $RH$, $WS$, and $DP$ were taken from NDAWN stations for the hour in which the fire behavior observation occurred. 

All variables were scaled to a common range prior to analysis, and units for each predictor variable are not reported. 

```{r eval=FALSE}
# Calculate 100 imputed datasets
  imp <- AnalysisData %>% 
              mutate_at(vars(plot, array), as.character) %>%
              mutate_at(vars(tempC:ros), ~as.numeric(scale(., center=F))) %>%
              select(-SoilMoisture) %>%
               mice(m=100, seed = 23109, print=F)
# Rate of spread
  # Fit model 
    ros_all <- with(imp, 
                  suppressMessages(
                    lme4::glmer(ros ~ RH + mean_mph + dpF + 
                               FuelMoisture + LAI + 
                            (1|location/block/year/plot), 
                       family=Gamma(link = "log"), 
                       control=lme4::glmerControl(optimizer="bobyqa", 
                                        optCtrl=list(maxfun=100000)) )) )
    # Pool results
    ros_terms <-   
      summary(pool(ros_all)) %>%
        mutate_at(vars(estimate:p.value), ~round(., 2)) %>%
        select(term, estimate) %>%
      bind_cols(confint.mipo(pool(ros_all)) %>%
                  as_tibble() %>%
                  round(2) ) %>%
        arrange(desc(abs(estimate)))
# Maximum temperature  
   # Fit model 
    temp_all <- with(imp, 
                  suppressMessages(
                    lme4::glmer(tempC ~ RH + mean_mph + dpF + 
                             FuelMoisture + LAI + 
                             (1|location/block/year/plot), 
                        family=Gamma(link = "log"), 
                        control=lme4::glmerControl(optimizer="bobyqa",
                                      optCtrl=list(maxfun=100000)) )) )

  # Pool results
    temp_terms <-   
     summary(pool(temp_all)) %>%
     mutate_at(vars(estimate:p.value), ~round(., 2)) %>%
     select(term, estimate) %>%
     bind_cols(confint.mipo(pool(temp_all)) %>%
                 as_tibble() %>%
                 round(2) ) %>%
     arrange(desc(abs(estimate)))

# Combine regression results 
response_CIs <-   
        bind_rows(
          mutate(ros_terms, response = "Rate of spread"), 
          mutate(temp_terms, response = 'Maximum temperature')
        )
```

# Results 

```{r fig.width=8, fig.height = 4}
# Plot confidence intervals
response_CIs %>%
  filter(term != '(Intercept)') %>%
  as_tibble() %>%
  mutate(term = recode(term, LAI = 'Fuel load', 
                             mean_mph = 'Wind speed', 
                             RH = 'Relative humidity', 
                             FuelMoisture = 'Fuel moisture', 
                             dpF = 'Dew point'))  %>%
  ggplot(aes(x = reorder(term, abs(estimate), max))) + theme_bw(16) + 
    geom_hline(yintercept = 0, color="black", linetype = 2) +
    geom_errorbar(aes(ymin = `2.5 %`, ymax = `97.5 %`), 
                  size = 1.1, width = 0.25, 
                  color = "blue") +
    geom_point(aes(y = estimate), pch = 21, 
               stroke = 1.5, size = 4,
               color = "blue", fill="lightblue") +
    labs(x = '', 
         y = 'Regression coefficient with 95% CI') + 
    coord_flip() + 
    facet_wrap(~ response) + 
    theme(axis.text.y = element_text(color="black", size = 14), 
          strip.text = element_text(size = 14))
```  

# Script

```{r script, ref.label=knitr::all_labels(!label %in% c('setup') ), echo=TRUE,eval=FALSE}
```    